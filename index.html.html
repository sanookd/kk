<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏≠‡∏á</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏≠‡∏á - ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥">
    <meta name="theme-color" content="#F59E0B">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏≠‡∏á">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%23F59E0B' width='512' height='512' rx='128'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='280' fill='white'>üèÜ</text></svg>">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèÜ</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap');
        body { font-family: 'Prompt', sans-serif; }
        
        /* PWA Install Button */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            z-index: 9999;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .install-prompt.show {
            display: flex;
            align-items: center;
            gap: 12px;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-yellow-50 to-orange-50 p-2 sm:p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-yellow-800 mb-4 sm:mb-6">
            üìä ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏≠‡∏á
        </h1>
        
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="flex flex-col gap-3">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <div>
                        <p class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ó‡πà‡∏á (‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠)</p>
                        <p id="priceShow" class="text-2xl sm:text-3xl font-bold text-yellow-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="refresh()" class="flex-1 sm:flex-none bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                        <button onclick="reset()" class="flex-1 sm:flex-none bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">‚ùå ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    </div>
                </div>
                <input type="number" id="priceInput" value="" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏≠‡∏á" class="border rounded-lg px-3 py-2 w-full" oninput="updatePrice()">
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-3">üî• ‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏°</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
                <input type="number" id="w1" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏£‡∏±‡∏°)" class="border rounded-lg px-3 py-2" oninput="calc()">
                <input type="number" id="p1" placeholder="% ‡∏ó‡∏≠‡∏á" class="border rounded-lg px-3 py-2" oninput="calc()">
                <input type="number" id="pr1" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏ß‡∏Å" class="border rounded-lg px-3 py-2" oninput="calc()">
            </div>
            <div class="space-y-2">
                <p class="font-semibold text-black">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: <span id="r1" class="text-lg whitespace-nowrap">0.00</span></p>
                <p class="font-semibold text-orange-600">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: <span id="r2" class="text-lg whitespace-nowrap">0.00</span></p>
                <p class="font-semibold text-red-600">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏ß‡∏Å): <span id="r3" class="text-lg whitespace-nowrap">0.00</span></p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-3">üá∞üá∑ ‡∏ó‡∏≠‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ (98%-99%)</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                <input type="number" id="w2" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏£‡∏±‡∏°)" class="border rounded-lg px-3 py-2" oninput="calc()">
                <input type="number" id="p2" placeholder="% ‡∏ó‡∏≠‡∏á" class="border rounded-lg px-3 py-2" oninput="calc()">
            </div>
            <div class="space-y-2">
                <div>
                    <p class="font-semibold">‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ:</p>
                    <p class="text-lg"><span id="r4" class="whitespace-nowrap">0.00</span> ‡∏ö‡∏≤‡∏ó <span id="d4" class="text-sm text-gray-600 whitespace-nowrap">(0.00 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á / 0.00 ‡∏ï‡∏∏‡∏•)</span></p>
                </div>
                <div>
                    <p class="font-semibold">‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ:</p>
                    <p class="text-lg"><span id="r5" class="whitespace-nowrap">0.00</span> ‡∏ö‡∏≤‡∏ó <span id="d5" class="text-sm text-gray-600 whitespace-nowrap">(0.00 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á / 0.00 ‡∏ï‡∏∏‡∏•)</span></p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-3">üáπüá≠ ‡∏ó‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì‡πÑ‡∏ó‡∏¢ / ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÑ‡∏ó‡∏¢ 96.5%</h2>
            <input type="number" id="w3" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏£‡∏±‡∏°)" class="border rounded-lg px-3 py-2 w-full mb-3" oninput="calc()">
            <div class="space-y-2">
                <div>
                    <p class="font-semibold">‡∏ó‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì:</p>
                    <p class="text-lg"><span id="r6" class="whitespace-nowrap">0.00</span> ‡∏ö‡∏≤‡∏ó <span id="d6" class="text-sm text-gray-600 whitespace-nowrap">(0.00 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á)</span></p>
                </div>
                <div>
                    <p class="font-semibold">‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á:</p>
                    <p class="text-lg"><span id="r7" class="whitespace-nowrap">0.00</span> ‡∏ö‡∏≤‡∏ó <span id="d7" class="text-sm text-gray-600 whitespace-nowrap">(0.00 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á)</span></p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-3">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
            <div class="space-y-3">
                <select id="type" class="border rounded-lg px-3 py-2 w-full">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                    <option value="1. ‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏° ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">1. ‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏° ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    <option value="2. ‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏° ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">2. ‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏° ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                    <option value="3. ‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏° ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏ß‡∏Å">3. ‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏° ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏ß‡∏Å</option>
                    <option value="4. ‡∏ó‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ">4. ‡∏ó‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</option>
                    <option value="5. ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ">5. ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</option>
                    <option value="6. ‡∏ó‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì‡πÑ‡∏ó‡∏¢">6. ‡∏ó‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì‡πÑ‡∏ó‡∏¢</option>
                    <option value="7. ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÑ‡∏ó‡∏¢">7. ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÑ‡∏ó‡∏¢</option>
                </select>
                <select id="payment" class="border rounded-lg px-3 py-2 w-full">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</option>
                    <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">1. ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                    <option value="‡πÇ‡∏≠‡∏ô">2. ‡πÇ‡∏≠‡∏ô</option>
                </select>
                <textarea id="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" class="border rounded-lg px-3 py-2 w-full" rows="2"></textarea>
                <input type="text" id="emp" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="border rounded-lg px-3 py-2 w-full">
                <button onclick="save()" class="w-full bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 font-semibold">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-3">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets</h2>
            <div class="flex gap-2">
                <input type="text" id="url" placeholder="URL ‡∏Ç‡∏≠‡∏á Google Apps Script" class="border rounded-lg px-3 py-2 flex-1 text-sm" readonly>
                <button onclick="unlockUrl()" id="btnUnlock" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">üîí ‡∏•‡πá‡∏≠‡∏Ñ</button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4">
            <h2 class="text-xl font-bold text-gray-800 mb-3">üîê ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
            <div class="flex gap-2 mb-3">
                <input type="password" id="pwd" placeholder="‡∏£‡∏´‡∏±‡∏™" class="border rounded-lg px-3 py-2 flex-1">
                <button onclick="admin()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            <div id="adminPanel" style="display:none" class="space-y-3 border-t pt-3">
                <button onclick="viewSummary()" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">üìä ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î -->
    <div id="summaryModal" style="display:none" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î</h3>
                <button onclick="closeSummary()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Date Picker -->
            <div class="mb-4 flex gap-2">
                <input type="date" id="summaryDate" class="border rounded-lg px-3 py-2 flex-1">
                <button onclick="refreshSummary()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">üîÑ ‡πÇ‡∏´‡∏•‡∏î</button>
            </div>
            
            <div id="summaryContent" class="space-y-4">
                <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
    <div id="modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
            <div id="modalTxt" class="mb-6"></div>
            <div class="flex gap-2">
                <button onclick="closeM()" class="flex-1 bg-gray-300 px-4 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmSave()" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
    <div id="ok" style="display:none" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h3 class="text-2xl font-bold text-green-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
        </div>
    </div>

    <script>
        let goldPrice = 0;
        let results = {};
        let selectedType = '';
        let selectedAmount = 0;
        let selectedProfit = 0;
        let selectedWeight = 0;
        let selectedPurity = 0;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á
        async function refresh() {
            try {
                document.getElementById('priceShow').textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
                
                const response = await fetch('https://api.chnwt.dev/thai-gold-api/latest');
                const data = await response.json();
                
                if (data && data.response && data.response.price && data.response.price.gold_bar) {
                    // ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                    let priceString = data.response.price.gold_bar.sell || data.response.price.gold_bar.buy || "0";
                    priceString = priceString.replace(/,/g, '');
                    goldPrice = Math.round(parseFloat(priceString));
                    
                    if (goldPrice > 0) {
                        document.getElementById('priceShow').textContent = goldPrice.toLocaleString('th-TH') + ' ‡∏ö‡∏≤‡∏ó';
                        document.getElementById('priceInput').value = goldPrice;
                        calc();
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                        const updateTime = data.response.update_time || '';
                        console.log('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', goldPrice, '‡∏ö‡∏≤‡∏ó', updateTime);
                        return;
                    }
                }
                
                throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤');
                
            } catch (error) {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡πÑ‡∏î‡πâ:', error);
                goldPrice = 0;
                document.getElementById('priceShow').textContent = '‚ùå ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
                document.getElementById('priceInput').value = '';
                document.getElementById('priceInput').placeholder = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏≠‡∏á';
            }
        }

        function updatePrice() {
            let inputValue = document.getElementById('priceInput').value;
            inputValue = inputValue.replace(/,/g, '');
            const newPrice = parseFloat(inputValue);
            
            if (!isNaN(newPrice) && newPrice > 0) {
                goldPrice = newPrice;
                document.getElementById('priceShow').textContent = Math.round(newPrice).toLocaleString('th-TH') + ' ‡∏ö‡∏≤‡∏ó';
                calc();
            }
        }

        function formatNumber(num) {
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function calc() {
            const w1 = parseFloat(document.getElementById('w1').value) || 0;
            const p1 = parseFloat(document.getElementById('p1').value) || 0;
            const pr1 = parseFloat(document.getElementById('pr1').value) || 0;
            const w2 = parseFloat(document.getElementById('w2').value) || 0;
            const p2 = parseFloat(document.getElementById('p2').value) || 0;
            const w3 = parseFloat(document.getElementById('w3').value) || 0;

            // ‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏°
            // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ((‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á*%‡∏ó‡∏≠‡∏á*0.0656)*‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)-5%
            const baseValue1 = ((goldPrice * (p1 / 100) * 0.0656) * w1);
            const amount1 = baseValue1 * 0.97; // -3%
            const profit1 = (((goldPrice + 1000) * (p1 / 100) * 0.0656) * w1) - amount1;
            const pricePerGram1 = w1 > 0 ? (amount1 / w1) : 0; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°
            
            results['1'] = {
                amount: amount1,
                profit: profit1,
                weight: w1,
                purity: p1
            };
            
            // ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ((‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á*%‡∏ó‡∏≠‡∏á*0.0656)*‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)
            const amount2 = baseValue1;
            const profit2 = (((goldPrice + 1000) * (p1 / 100) * 0.0656) * w1) - amount2;
            const pricePerGram2 = w1 > 0 ? (amount2 / w1) : 0; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°
            
            results['2'] = {
                amount: amount2,
                profit: profit2,
                weight: w1,
                purity: p1
            };
            
            // ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏ß‡∏Å): ((‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á+‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏ß‡∏Å)*%‡∏ó‡∏≠‡∏á*0.0656)*‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
            const baseValue1WithExtra = (((goldPrice + pr1) * (p1 / 100) * 0.0656) * w1);
            const amount3 = baseValue1WithExtra;
            const profit3 = (((goldPrice + 1000) * (p1 / 100) * 0.0656) * w1) - amount3;
            const pricePerGram3 = w1 > 0 ? (amount3 / w1) : 0; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°
            
            results['3'] = {
                amount: amount3,
                profit: profit3,
                weight: w1,
                purity: p1
            };

            document.getElementById('r1').textContent = formatNumber(amount1) + ' ‡∏ö‡∏≤‡∏ó (' + formatNumber(pricePerGram1) + ' ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)';
            document.getElementById('r2').textContent = formatNumber(amount2) + ' ‡∏ö‡∏≤‡∏ó (' + formatNumber(pricePerGram2) + ' ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)';
            document.getElementById('r3').textContent = formatNumber(amount3) + ' ‡∏ö‡∏≤‡∏ó (' + formatNumber(pricePerGram3) + ' ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)';

            // ‡∏ó‡∏≠‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ
            const baseValue2 = ((goldPrice * (p2 / 100) * 0.0656) * w2);
            
            // ‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ: ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á = ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/15.16, ‡∏ï‡∏∏‡∏• = ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/3.75
            const bahtGold2Rupa = w2 / 15.16;
            const tul2 = w2 / 3.75;
            
            // ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ: ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á = ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/15.244
            const bahtGold2Thong = w2 / 15.244;
            
            // ‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ: ((‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á*%‡∏ó‡∏≠‡∏á*0.0656)*‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)-1%
            const amount4 = baseValue2 * 0.99; // -1%
            const profit4 = (((goldPrice + 1000) * (p2 / 100) * 0.0656) * w2) - amount4;
            const pricePerGram4 = w2 > 0 ? (amount4 / w2) : 0; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°
            
            results['4'] = {
                amount: amount4,
                profit: profit4,
                weight: w2,
                purity: p2
            };
            
            // ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ: ((‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á*%‡∏ó‡∏≠‡∏á*0.0656)*‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)
            const amount5 = baseValue2;
            const profit5 = (((goldPrice + 1000) * (p2 / 100) * 0.0656) * w2) - amount5;
            const pricePerGram5 = w2 > 0 ? (amount5 / w2) : 0; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°
            
            results['5'] = {
                amount: amount5,
                profit: profit5,
                weight: w2,
                purity: p2
            };

            document.getElementById('r4').textContent = formatNumber(amount4);
            document.getElementById('d4').textContent = `(${formatNumber(bahtGold2Rupa)} ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á / ${formatNumber(tul2)} ‡∏ï‡∏∏‡∏• / ${formatNumber(pricePerGram4)} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)`;
            document.getElementById('r5').textContent = formatNumber(amount5);
            document.getElementById('d5').textContent = `(${formatNumber(bahtGold2Thong)} ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á / ${formatNumber(pricePerGram5)} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)`;

            // ‡∏ó‡∏≠‡∏á‡πÑ‡∏ó‡∏¢ 96.5%
            // ‡∏ó‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì: ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á (15.16 ‡∏Å‡∏£‡∏±‡∏° = 1 ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á)
            const goldPriceRupapanh = goldPrice * 0.955; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á - 4.5%
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á
            const totalBaht = w3 / 15.16;
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (0.125, 0.25, 0.5, 0.75, 1.0, ...)
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î 0.125 (1/8 ‡∏ö‡∏≤‡∏ó = 1 ‡∏™‡∏•‡∏∂‡∏á)
            const roundedBaht = Math.round(totalBaht * 8) / 8;
            const isExactBaht = Math.abs(totalBaht - roundedBaht) < 0.0001;
            
            let baseValue3Rupapanh = 0;
            let actualWeight3Rupa = w3; // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏£‡∏¥‡∏á
            
            if (w3 > 0) {
                if (isExactBaht) {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á‡∏•‡∏á‡∏ï‡∏±‡∏ß ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏£‡∏á‡πÜ
                    baseValue3Rupapanh = totalBaht * goldPriceRupapanh;
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ï‡∏±‡∏ß ‚Üí ‡πÅ‡∏¢‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏®‡∏©
                    const wholeBaht = Math.floor(totalBaht);
                    const fractionalBaht = totalBaht - wholeBaht;
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏®‡∏©‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1.1% ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const fractionalPercent = totalBaht > 0 ? (fractionalBaht / totalBaht) : 0;
                    const shouldCalculateFraction = fractionalPercent >= 0.011;
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
                    const wholePrice = wholeBaht * goldPriceRupapanh;
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏®‡∏© (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    let fractionPrice = 0;
                    if (shouldCalculateFraction && fractionalBaht > 0) {
                        const fractionWeight = fractionalBaht * 15.16; // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏®‡∏© (‡∏Å‡∏£‡∏±‡∏°)
                        fractionPrice = (goldPriceRupapanh * 0.0656) * fractionWeight;
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏®‡∏©‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 1.1% ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏≤‡∏ó
                        actualWeight3Rupa = wholeBaht * 15.16;
                    }
                    
                    baseValue3Rupapanh = wholePrice + fractionPrice;
                }
            }
            
            const bahtGold3Rupa = totalBaht; // ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á
            const pricePerGram3Rupa = actualWeight3Rupa > 0 ? (baseValue3Rupapanh / actualWeight3Rupa) : 0; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°
            
            // ‡∏ó‡∏≠‡∏á‡πÅ‡∏ó‡πà‡∏á: (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á*0.0656)*‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
            const baseValue3Thong = (goldPrice * 0.0656) * w3;
            const bahtGold3Thong = w3 / 15.244; // ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á (‡πÅ‡∏ó‡πà‡∏á)
            const pricePerGram3Thong = w3 > 0 ? (baseValue3Thong / w3) : 0; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°
            
            // ‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏£‡∏ì
            const profit6 = (((goldPrice + 1000) * 0.965 * 0.0656) * w3) - baseValue3Rupapanh;
            
            // ‡∏Å‡∏≥‡πÑ‡∏£‡πÅ‡∏ó‡πà‡∏á
            const profit7 = (((goldPrice + 1000) * 0.965 * 0.0656) * w3) - baseValue3Thong;

            results['6'] = {
                amount: baseValue3Rupapanh,
                profit: profit6,
                weight: w3,
                purity: 96.5
            };
            results['7'] = {
                amount: baseValue3Thong,
                profit: profit7,
                weight: w3,
                purity: 96.5
            };

            document.getElementById('r6').textContent = formatNumber(baseValue3Rupapanh);
            document.getElementById('d6').textContent = `(${formatNumber(bahtGold3Rupa)} ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á / ${formatNumber(pricePerGram3Rupa)} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)`;
            document.getElementById('r7').textContent = formatNumber(baseValue3Thong);
            document.getElementById('d7').textContent = `(${formatNumber(bahtGold3Thong)} ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≠‡∏á / ${formatNumber(pricePerGram3Thong)} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏£‡∏±‡∏°)`;
        }

        function save() {
            const type = document.getElementById('type').value;
            const payment = document.getElementById('payment').value;
            const emp = document.getElementById('emp').value;
            const note = document.getElementById('note').value;

            if (!type || !payment || !emp) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            const typeNum = type.split('.')[0];
            const result = results[typeNum];

            if (!result || result.amount <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            selectedType = type;
            selectedAmount = result.amount;
            selectedProfit = result.profit;
            selectedWeight = result.weight;
            selectedPurity = result.purity;

            document.getElementById('modalTxt').innerHTML = `
                <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${type}</p>
                <p><strong>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</strong> ${selectedWeight} ‡∏Å‡∏£‡∏±‡∏°</p>
                <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå:</strong> ${selectedPurity}%</p>
                <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠:</strong> ${formatNumber(selectedAmount)} ‡∏ö‡∏≤‡∏ó</p>
                
                <p><strong>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${payment}</p>
                <p><strong>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</strong> ${emp}</p>
                ${note ? `<p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${note}</p>` : ''}
            `;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeM() {
            document.getElementById('modal').style.display = 'none';
        }

        async function confirmSave() {
            const url = document.getElementById('url').value;
            if (!url) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const data = {
                date: new Date().toLocaleString('th-TH'),
                employee: document.getElementById('emp').value,
                type: selectedType,
                weight: selectedWeight,
                purity: selectedPurity,
                amount: selectedAmount,
                profit: selectedProfit,
                goldPrice: goldPrice,
                paymentMethod: document.getElementById('payment').value,
                note: document.getElementById('note').value
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                closeM();
                document.getElementById('ok').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('ok').style.display = 'none';
                    reset();
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        function reset() {
            document.getElementById('w1').value = '';
            document.getElementById('p1').value = '';
            document.getElementById('pr1').value = '';
            document.getElementById('w2').value = '';
            document.getElementById('p2').value = '';
            document.getElementById('w3').value = '';
            document.getElementById('type').value = '';
            document.getElementById('payment').value = '';
            document.getElementById('note').value = '';
            document.getElementById('emp').value = '';
            calc();
        }

        function admin() {
            const pwd = document.getElementById('pwd').value;
            if (pwd === 'admin123') {
                document.getElementById('adminPanel').style.display = 'block';
                alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } else {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
        }

        function unlockUrl() {
            const urlInput = document.getElementById('url');
            const btnUnlock = document.getElementById('btnUnlock');
            
            if (urlInput.readOnly) {
                const password = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL:');
                if (password === 'admin123') {
                    urlInput.readOnly = false;
                    btnUnlock.textContent = 'üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ';
                    btnUnlock.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    btnUnlock.classList.add('bg-green-500', 'hover:bg-green-600');
                } else {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            } else {
                urlInput.readOnly = true;
                btnUnlock.textContent = 'üîí ‡∏•‡πá‡∏≠‡∏Ñ';
                btnUnlock.classList.remove('bg-green-500', 'hover:bg-green-600');
                btnUnlock.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                localStorage.setItem('sheetUrl', urlInput.value);
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å ISO ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ó‡∏¢
        function parseThaiDate(dateStr) {
            try {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ISO format (2568-11-02T12:40:36.000Z ‡∏´‡∏£‡∏∑‡∏≠ 2025-11-02T12:40:36.000Z)
                if (dateStr.includes('T') && dateStr.includes('Z')) {
                    // ‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ISO string
                    const datePart = dateStr.split('T')[0]; // ‡πÑ‡∏î‡πâ "2568-11-02"
                    const [year, month, day] = datePart.split('-').map(Number);
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏µ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ.‡∏®.
                    let thaiYear = year;
                    if (year < 2500) {
                        // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 2500 = ‡∏Ñ.‡∏®. ‚Üí ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
                        thaiYear = year + 543;
                    }
                    // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 2500 = ‡∏û.‡∏®. ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏á‡πÜ
                    
                    return `${day}/${month}/${thaiYear}`;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ (2/11/2568, 14:30:25)
                if (dateStr.includes(',')) {
                    return dateStr.split(',')[0].trim();
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô
                return dateStr;
            } catch (e) {
                console.error('Error parsing date:', e);
                return dateStr;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
        async function viewSummary() {
            const url = document.getElementById('url').value;
            if (!url) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const today = new Date();
            const dateInput = document.getElementById('summaryDate');
            dateInput.valueAsDate = today;

            document.getElementById('summaryModal').style.display = 'flex';
            refreshSummary();
        }

        async function refreshSummary() {
            const url = document.getElementById('url').value;
            const dateInput = document.getElementById('summaryDate');
            
            if (!url) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            if (!dateInput.value) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
                return;
            }

            document.getElementById('summaryContent').innerHTML = '<p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';

            try {
                const timestamp = new Date().getTime();
                const fetchUrl = url.includes('?') ? `${url}&t=${timestamp}` : `${url}?t=${timestamp}`;
                
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data || data.length <= 1) {
                    document.getElementById('summaryContent').innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                    return;
                }

                // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const selectedDate = new Date(dateInput.value);
                const selectedDay = selectedDate.getDate();
                const selectedMonth = selectedDate.getMonth() + 1;
                const selectedYear = selectedDate.getFullYear() + 543;
                const selectedDateStr = `${selectedDay}/${selectedMonth}/${selectedYear}`;
                const selectedDateStr2 = `${selectedDay.toString().padStart(2, '0')}/${selectedMonth.toString().padStart(2, '0')}/${selectedYear}`;
                
                console.log('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:', selectedDateStr, selectedDateStr2);
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const filteredData = data.slice(1).filter(row => {
                    const rowDate = row[0];
                    if (!rowDate) return false;
                    
                    const parsedDate = parseThaiDate(String(rowDate));
                    console.log('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Sheet:', rowDate, '‚Üí ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô:', parsedDate);
                    
                    const match = parsedDate === selectedDateStr || parsedDate === selectedDateStr2;
                    console.log('‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö:', parsedDate, '===', selectedDateStr, '?', match);
                    
                    return match;
                });

                if (filteredData.length === 0) {
                    document.getElementById('summaryContent').innerHTML = `
                        <div class="text-center p-6">
                            <div class="text-6xl mb-4">üì≠</div>
                            <p class="text-gray-500 text-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                            <p class="text-gray-400 text-sm mt-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${selectedDateStr2}</p>
                            <div class="mt-4 text-xs text-gray-500">
                                <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${data.length - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                let totalAmount = 0;
                let totalProfit = 0;
                let totalWeight = 0;
                let totalWeightedPurity = 0; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì %‡∏ó‡∏≠‡∏á ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
                let cashCount = 0;
                let transferCount = 0;
                const typeCount = {};
                const employeeData = {};

                filteredData.forEach(row => {
                    const amount = parseFloat(row[5]) || 0;
                    const profit = parseFloat(row[6]) || 0;
                    const weight = parseFloat(row[3]) || 0;
                    const purity = parseFloat(row[4]) || 0; // %‡∏ó‡∏≠‡∏á
                    const payment = row[8] || '';
                    const type = row[2] || '';
                    const employee = row[1] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

                    totalAmount += amount;
                    totalProfit += profit;
                    totalWeight += weight;
                    totalWeightedPurity += (purity * weight); // %‡∏ó‡∏≠‡∏á √ó ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å

                    if (payment === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') cashCount++;
                    if (payment === '‡πÇ‡∏≠‡∏ô') transferCount++;

                    typeCount[type] = (typeCount[type] || 0) + 1;
                    
                    if (!employeeData[employee]) {
                        employeeData[employee] = { count: 0, amount: 0, profit: 0, weight: 0 };
                    }
                    employeeData[employee].count++;
                    employeeData[employee].amount += amount;
                    employeeData[employee].profit += profit;
                    employeeData[employee].weight += weight;
                });

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì %‡∏ó‡∏≠‡∏á ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
                const avgPurity = totalWeight > 0 ? (totalWeightedPurity / totalWeight) : 0;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
                let allTotalAmount = 0;
                let allTotalProfit = 0;
                let allTotalWeight = 0;
                let allTotalWeightedPurity = 0;

                data.slice(1).forEach(row => {
                    const amount = parseFloat(row[5]) || 0;
                    const profit = parseFloat(row[6]) || 0;
                    const weight = parseFloat(row[3]) || 0;
                    const purity = parseFloat(row[4]) || 0;

                    allTotalAmount += amount;
                    allTotalProfit += profit;
                    allTotalWeight += weight;
                    allTotalWeightedPurity += (purity * weight);
                });

                const allAvgPurity = allTotalWeight > 0 ? (allTotalWeightedPurity / allTotalWeight) : 0;

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                let html = `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="font-bold text-lg mb-2">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${selectedDateStr2}</h4>
                        <p class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${filteredData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-2xl font-bold text-green-600">${formatNumber(totalAmount)} ‡∏ø</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">‡∏Å‡∏≥‡πÑ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <p class="text-2xl font-bold text-yellow-600">${formatNumber(totalProfit)} ‡∏ø</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°</p>
                            <p class="text-2xl font-bold text-orange-600">${formatNumber(totalWeight)} ‡∏Å‡∏£‡∏±‡∏°</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">%‡∏ó‡∏≠‡∏á ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</p>
                            <p class="text-2xl font-bold text-purple-600">${formatNumber(avgPurity)}%</p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h5 class="font-bold mb-2">üí≥ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h5>
                        <div class="flex justify-between">
                            <span>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: ${cashCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            <span>‡πÇ‡∏≠‡∏ô: ${transferCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h5 class="font-bold mb-2">üìã ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏≠‡∏á</h5>
                        <div class="space-y-1">
                `;

                for (const [type, count] of Object.entries(typeCount)) {
                    html += `<div class="flex justify-between"><span>${type}</span><span>${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div>`;
                }

                html += `</div></div>`;
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                html += `
                    <div class="bg-purple-50 p-4 rounded-lg mb-4">
                        <h5 class="font-bold mb-2">üë§ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h5>
                        <div class="space-y-2">
                `;

                for (const [employee, data] of Object.entries(employeeData)) {
                    html += `
                        <div class="bg-white p-3 rounded border">
                            <p class="font-semibold">${employee}</p>
                            <div class="text-sm text-gray-600 mt-1">
                                <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${data.count} | ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${formatNumber(data.weight)} ‡∏Å‡∏£‡∏±‡∏°</p>
                                <p>‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠: ${formatNumber(data.amount)} ‡∏ø | ‡∏Å‡∏≥‡πÑ‡∏£: ${formatNumber(data.profit)} ‡∏ø</p>
                            </div>
                        </div>
                    `;
                }

                html += `</div></div>`;
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                html += `
                    <div class="bg-white p-4 rounded-lg mb-4 border-2 border-blue-200">
                        <h5 class="font-bold mb-3 text-lg">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-2 py-2 text-left">#</th>
                                        <th class="px-2 py-2 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                        <th class="px-2 py-2 text-right">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
                                        <th class="px-2 py-2 text-right">%‡∏ó‡∏≠‡∏á</th>
                                        <th class="px-2 py-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                        <th class="px-2 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£</th>
                                        <th class="px-2 py-2 text-center">‡∏ä‡∏≥‡∏£‡∏∞</th>
                                        <th class="px-2 py-2 text-left">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                filteredData.forEach((row, index) => {
                    const employee = row[1] || '-';
                    const type = row[2] || '-';
                    const weight = parseFloat(row[3]) || 0;
                    const purity = parseFloat(row[4]) || 0;
                    const amount = parseFloat(row[5]) || 0;
                    const profit = parseFloat(row[6]) || 0;
                    const payment = row[8] || '-';
                    const note = row[7] || '';
                    
                    const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    const paymentColor = payment === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' ? 'text-green-600' : 'text-blue-600';
                    
                    html += `
                        <tr class="${rowBg} hover:bg-blue-50">
                            <td class="px-2 py-2 font-semibold">${index + 1}</td>
                            <td class="px-2 py-2">${type}</td>
                            <td class="px-2 py-2 text-right">${formatNumber(weight)}</td>
                            <td class="px-2 py-2 text-right">${formatNumber(purity)}%</td>
                            <td class="px-2 py-2 text-right font-semibold">${formatNumber(amount)}</td>
                            <td class="px-2 py-2 text-right text-yellow-600">${formatNumber(profit)}</td>
                            <td class="px-2 py-2 text-center ${paymentColor} font-semibold">${payment}</td>
                            <td class="px-2 py-2">${employee}</td>
                        </tr>
                    `;
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    if (note) {
                        html += `
                            <tr class="${rowBg}">
                                <td colspan="8" class="px-2 py-1 text-xs text-gray-600 italic">
                                    üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${note}
                                </td>
                            </tr>
                        `;
                    }
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                html += `
                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 p-4 rounded-lg mb-4 text-white">
                        <h4 class="font-bold text-xl mb-3">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</h4>
                        <p class="text-sm opacity-90 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${data.length - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div class="bg-white bg-opacity-20 p-3 rounded-lg backdrop-blur-sm">
                                <p class="text-xs opacity-90">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-xl font-bold">${formatNumber(allTotalAmount)} ‡∏ø</p>
                            </div>
                            <div class="bg-white bg-opacity-20 p-3 rounded-lg backdrop-blur-sm">
                                <p class="text-xs opacity-90">‡∏Å‡∏≥‡πÑ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-xl font-bold">${formatNumber(allTotalProfit)} ‡∏ø</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white bg-opacity-20 p-3 rounded-lg backdrop-blur-sm">
                                <p class="text-xs opacity-90">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                <p class="text-xl font-bold">${formatNumber(allTotalWeight)} ‡∏Å‡∏£‡∏±‡∏°</p>
                            </div>
                            <div class="bg-white bg-opacity-20 p-3 rounded-lg backdrop-blur-sm">
                                <p class="text-xs opacity-90">%‡∏ó‡∏≠‡∏á ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</p>
                                <p class="text-xl font-bold">${formatNumber(allAvgPurity)}%</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('summaryContent').innerHTML = html;

            } catch (error) {
                console.error('Error fetching summary:', error);
                document.getElementById('summaryContent').innerHTML = `
                    <div class="text-center p-6">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <p class="text-red-500 font-semibold mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
                        <p class="text-sm text-gray-600 mb-4">${error.message}</p>
                    </div>
                `;
            }
        }

        function closeSummary() {
            document.getElementById('summaryModal').style.display = 'none';
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°
        window.onload = function() {
            const savedUrl = localStorage.getItem('sheetUrl');
            if (savedUrl) {
                document.getElementById('url').value = savedUrl;
            }
            
            // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏à‡∏≤‡∏Å API ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            refresh();
        };
    </script>
    
    <!-- PWA Install Prompt -->
    <div id="installPrompt" class="install-prompt">
        <span>üì± ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏û</span>
        <button onclick="installPWA()" class="bg-white text-purple-600 px-4 py-1 rounded-full font-semibold">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</button>
        <button onclick="closeInstallPrompt()" class="text-white opacity-75 hover:opacity-100">‚úï</button>
    </div>
    
    <!-- PWA Service Worker -->
    <script>
        let deferredPrompt;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ browser ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Service Worker ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
        
        // ‡∏à‡∏±‡∏ö event ‡πÄ‡∏°‡∏∑‡πà‡∏≠ browser ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ‡πÅ‡∏™‡∏î‡∏á install prompt ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                document.getElementById('installPrompt').classList.add('show');
            }, 3000);
        });
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á PWA
        function installPWA() {
            if (!deferredPrompt) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Safari ‡∏´‡∏£‡∏∑‡∏≠ Chrome ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏û');
                return;
            }
            
            document.getElementById('installPrompt').classList.remove('show');
            deferredPrompt.prompt();
            
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('‚úÖ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏û‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    console.log('‚ùå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á');
                }
                deferredPrompt = null;
            });
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î install prompt
        function closeInstallPrompt() {
            document.getElementById('installPrompt').classList.remove('show');
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏û‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ ‡πÅ‡∏≠‡∏û‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            document.getElementById('installPrompt').classList.remove('show');
        });
        
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS Safari
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏û');
        }
    </script>
</body>
</html>
